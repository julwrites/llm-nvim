name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: docker://ghcr.io/julwrites/llm-nvim-build-ubuntu:main
    steps:
    - uses: actions/checkout@v2

    - name: Install plenary.nvim for tests
      uses: actions/checkout@v2
      with:
        repository: nvim-lua/plenary.nvim
        path: test/plenary.nvim
        depth: 1

    - name: Run tests
      run: |
        make test
        nvim --headless -c "set rtp+=$GITHUB_WORKSPACE/test/plenary.nvim" -c "set rtp+=$GITHUB_WORKSPACE" -c "PlenaryBustedDirectory test/spec { minimal_init = 'test/init.lua' }" -c "qa!"

  coverage:
    runs-on: ubuntu-latest
    container:
      image: docker://ghcr.io/julwrites/llm-nvim-build-ubuntu:main
    steps:
    - uses: actions/checkout@v2

    - name: Install test dependencies
      run: |
        luarocks install --local busted
        luarocks install --local luacov
        luarocks install --local luacov-console

    - name: Run coverage
      id: coverage
      run: |
        export PATH=$HOME/.luarocks/bin:$PATH
        make coverage
      env:
        LUA_PATH: "./lua/?.lua;;"

    - name: Check coverage
      run: |
        export PATH=$HOME/.luarocks/bin:$PATH
        COVERAGE=$(luacov-console -s | grep 'Total' | awk '{print $3}' | sed 's/%//')
        echo "Current coverage is $COVERAGE%"
        if (( $(echo "$COVERAGE < 70" | bc -l) )); then
          echo "Coverage is below 70%. Failing build."
          exit 1
        fi
